#!/usr/bin/env ansible-playbook
---
- hosts: localhost
  gather_facts: false
  tasks:
    - copy:
        # Change this to `dest: .sops.yaml`
        dest: sops-example.yaml
        content: |
          ##########################################################################
          ## WARNING: THIS FILE IS AUTOMATICALLY GENERATED! DO NOT EDIT MANUALLY! ##
          ##########################################################################
          ## Use ./create-config.yml to create/update it.                          ##
          ##########################################################################
          {% macro add_pgp_keys(key_names) %}
            {{- 'pgp: ' -}}
            {%- for key_name in key_names -%}
              {{ query('community.crypto.gpg_fingerprint', 'keys/sops/' ~ key_name, what='fingerprint')[0] }}{% if not loop.last %},{% endif %}
            {%- endfor -%}
          {% endmacro %}

          creation_rules:
            # Everything else
            - {{ add_pgp_keys(user_keys + cold_storage_keys) }}

          ##########################################################################
          ## WARNING: THIS FILE IS AUTOMATICALLY GENERATED! DO NOT EDIT MANUALLY! ##
          ##########################################################################
      vars:
        # The user keys to add. You could also use the ansible.builtin.fileglob lookup
        # to pick up all files in a directory.
        user_keys:
          - felix-laptop-2024-10-01-public
          - felix-desktop-2022-02-01-public
        cold_storage_keys:
          - sops-cold-storage-2020-01-05-public
